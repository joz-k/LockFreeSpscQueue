# The name of the workflow, displayed in the "Actions" tab.
name: Run Comparative Benchmarks (Manual)

# This section defines the trigger for the workflow.
on:
  workflow_dispatch:
    inputs:
      git-ref:
        description: 'The Git branch, tag, or commit SHA to run the benchmark on.'
        required: true
        default: 'main'

jobs:
  # This single job will run in parallel on all three platforms.
  benchmark:
    # The name of the job will be dynamic, including the OS name.
    name: Benchmark on ${{ matrix.os }}

    # Use a matrix strategy to run on all three major platforms.
    strategy:
      matrix:
        os: [ubuntu-latest, macos-14, windows-latest]

    # Run on the OS specified by the current matrix configuration.
    runs-on: ${{ matrix.os }}

    steps:
      # --- Print System Hardware Information ---
      - name: Print Linux Hardware Info
        if: runner.os == 'Linux'
        run: |
          echo "==================== Hardware Information ===================="
          echo "--- CPU ---"
          lscpu
          echo -e "\n--- Memory ---"
          free -h
          echo "=========================================================="

      - name: Print macOS Hardware Info
        if: runner.os == 'macOS'
        run: |
          echo "==================== Hardware Information ===================="
          echo "--- CPU ---"
          sysctl -a | grep machdep.cpu
          echo -e "\n--- Memory ---"
          sysctl hw.memsize
          echo "=========================================================="

      - name: Print Windows Hardware Info
        if: runner.os == 'Windows'
        run: |
          echo "==================== Hardware Information ===================="
          echo "--- CPU ---"
          Get-CimInstance Win32_Processor | Select-Object Name, NumberOfCores, NumberOfLogicalProcessors
          echo "--- Memory ---"
          (Get-CimInstance Win32_ComputerSystem).TotalPhysicalMemory
          echo "=========================================================="

      # Step 2: Check out the specific Git ref provided by the user.
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git-ref }}

      # Step 3: Install latest LLVM/Clang on macOS using Homebrew.
      - name: Install latest Clang on macOS via Homebrew
        if: matrix.os == 'macos-14'
        run: |
          brew install llvm
          echo "CC=$(brew --prefix llvm)/bin/clang" >> $GITHUB_ENV
          echo "CXX=$(brew --prefix llvm)/bin/clang++" >> $GITHUB_ENV

      # Step 4: Configure CMake for a Release build with the comparison benchmark enabled.
      - name: Configure CMake
        run: >
          cmake -S . -B build
          -DCMAKE_BUILD_TYPE=Release
          -DSPSC_QUEUE_BUILD_BENCHMARK_COMPARE=ON

      # Step 5: Build the project.
      - name: Build Project
        run: cmake --build build --config Release

      # Step 6: Run the benchmark.
      - name: Run on Linux/macOS
        if: runner.os != 'Windows'
        run: ./build/benchmarks/queue_comparison_benchmark

      - name: Run on Windows
        if: runner.os == 'Windows'
        run: .\build\benchmarks\Release\queue_comparison_benchmark.exe

